<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Trading Journal Final + LocalStorage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {margin:0;font-family:Arial,Helvetica,sans-serif;background:#0b0f16;color:#e5e7eb;padding:20px;}
    h2 {margin:10px 0;font-weight:600;}
    input,button {background:#111827;color:#e5e7eb;border:1px solid #1f2933;padding:6px 10px;border-radius:6px;margin-right:6px;}
    button {cursor:pointer;transition:background .2s;}
    button:hover {background:#1f2933;}
    .row {display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .top {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-top:16px;}
    .card {background:#1e293b;padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.3);}
    .card b {font-size:22px;display:block;margin-top:4px;}
    .label {opacity:.75;font-size:13px;font-weight:500;}
    .chart-box {background:#1e293b;margin-top:20px;border-radius:14px;padding:20px;}
    canvas {height:260px!important}
    .days {display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-top:20px;}
    .day {background:#111827;padding:12px;border-radius:10px;font-size:13px;border:1px solid #1f2933;}
    .win {border-left:4px solid #22c55e;background:#0e1d15;}
    .loss {border-left:4px solid #ef4444;background:#1f1315;}
    .week {display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:20px;}
    .small b {font-size:18px}
    .bar {background:#1f2933;border-radius:6px;height:6px;margin-top:6px;overflow:hidden;}
    .bar-fill {height:6px;border-radius:6px;width:0%;background:#22c55e;transition:width .4s ease;}
    .metric.green {color:#22c55e;}
    .metric.red {color:#ef4444;}
  </style>
</head>
<body id="journal">
  <h2>Trading Journal</h2>

  <div class="row">
    Bulan: <input id="month" type="text" value="Desember">
    Tahun: <input id="year" type="number" value="2025">
    Modal Awal: <input id="capital" type="number" value="1000" step="0.01">
    <button id="resetCapitalBtn">Reset Modal</button>
    <button onclick="exportPDF()">Export PDF</button>
    <span id="title">Desember 2025</span>
  </div>

  <div class="top">
    <div class="card"><div class="label">Net P&L</div><b id="net" class="metric">$0</b><div class="bar"><div id="netBar" class="bar-fill"></div></div></div>
    <div class="card"><div class="label">Trade Win %</div><b id="winrate" class="metric">0%</b><div class="bar"><div id="winrateBar" class="bar-fill"></div></div></div>
    <div class="card"><div class="label">Profit Factor</div><b id="pf" class="metric">0</b><div class="bar"><div id="pfBar" class="bar-fill"></div></div></div>
    <div class="card"><div class="label">Day Win %</div><b id="daywin" class="metric">0%</b><div class="bar"><div id="daywinBar" class="bar-fill"></div></div></div>
    <div class="card"><div class="label">Avg Win/Loss</div><b id="awl" class="metric">0</b><div class="bar"><div id="awlBar" class="bar-fill"></div></div></div>
    <div class="card"><div class="label">Modal Saat Ini</div><b id="equity" class="metric">$0</b><div class="bar"><div id="equityBar" class="bar-fill"></div></div></div>
  </div>

  <div class="chart-box"><canvas id="equityChart"></canvas></div>

  <div class="row" style="margin-top:14px">
    Day: <input id="day" type="number" min="1" max="31">
    P&L: <input id="pnl" type="number" step="0.01">
    <button id="saveDayBtn">Save</button>
    <button id="clearDayBtn">Clear</button>
    <button id="resetMonthBtn">Reset Bulan</button>
  </div>

  <div class="days" id="days"></div>

  <div class="week">
    <div class="card small">Week 1<br><b id="w1" class="metric">$0</b><div class="bar"><div id="w1Bar" class="bar-fill"></div></div></div>
    <div class="card small">Week 2<br><b id="w2" class="metric">$0</b><div class="bar"><div id="w2Bar" class="bar-fill"></div></div></div>
    <div class="card small">Week 3<br><b id="w3" class="metric">$0</b><div class="bar"><div id="w3Bar" class="bar-fill"></div></div></div>
    <div class="card small">Week 4<br><b id="w4" class="metric">$0</b><div class="bar"><div id="w4Bar" class="bar-fill"></div></div></div>
  </div>

  <div class="week">
    <div class="card small">Drawdown Max<br><b id="dd" class="metric">0%</b><div class="bar"><div id="ddBar" class="bar-fill"></div></div></div>
    <div class="card small">Return Bulanan<br><b id="rm" class="metric">0%</b><div class="bar"><div id="rmBar" class="bar-fill"></div></div></div>
    <div class="card small">Return Q1<br><b id="rq" class="metric">0%</b><div class="bar"><div id="rqBar" class="bar-fill"></div></div></div>
  </div>

<script>
  // State
  let data = Array(31).fill(null);
  let chart;

  // Helpers
  const fmtUSD = v => '$' + Number(v).toFixed(2);
  const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
  const safeDiv = (a,b) => (b && b !== 0) ? (a/b) : 0;

  // Storage (harian per bulan/tahun)
  function storageKey(){
    const m = (document.getElementById('month').value || 'Bulan').trim();
    const y = (document.getElementById('year').value || 'Tahun').toString().trim();
    return `journal_${m}_${y}`;
  }
  function saveToStorage(){ localStorage.setItem(storageKey(), JSON.stringify(data)); }
  function loadFromStorage(){
    const saved = localStorage.getItem(storageKey());
    if(saved){
      try{ data = JSON.parse(saved); }
      catch(e){ data = Array(31).fill(null); }
    } else {
      data = Array(31).fill(null);
    }
  }

  // Header
  function updateHeader(){
    const m=document.getElementById('month').value || '';
    const y=document.getElementById('year').value || '';
    document.getElementById('title').innerText=`${m} ${y}`;
  }
  function reloadData(){
    updateHeader();
    loadFromStorage();
    update();
  }

  // Inputs
  function saveDay(){
    const d=(parseInt(document.getElementById('day').value,10)||0)-1;
    const p=parseFloat(document.getElementById('pnl').value);
    if(d>=0 && d<31 && !isNaN(p)){ data[d]=p; update(); }
  }
  function clearDay(){
    const d=(parseInt(document.getElementById('day').value,10)||0)-1;
    if(d>=0 && d<31){ data[d]=null; update(); }
  }
  function resetMonth(){
    if(confirm('Reset semua data bulan ini?')){
      data = Array(31).fill(null);
      localStorage.removeItem(storageKey());
      update();
    }
  }

  // Metric writers
  function setMetricCurrency(id, value, barMax=100){
    const el = document.getElementById(id);
    const bar = document.getElementById(id+'Bar');
    const v = Number(value || 0);
    el.classList.remove('green','red');
    el.classList.add(v >= 0 ? 'green' : 'red');
    el.innerText = fmtUSD(v);
    if(bar){
      bar.style.width = clamp(Math.abs(v), 0, barMax) + '%';
      bar.style.background = v >= 0 ? '#22c55e' : '#ef4444';
    }
  }
  function setMetricPercent(id, value){
    const el = document.getElementById(id);
    const bar = document.getElementById(id+'Bar');
    const v = Number(value || 0);
    el.classList.remove('green','red');
    el.classList.add(v >= 0 ? 'green' : 'red');
    el.innerText = v.toFixed(2) + '%';
    if(bar){
      bar.style.width = clamp(Math.abs(v), 0, 100) + '%';
      bar.style.background = v >= 0 ? '#22c55e' : '#ef4444';
    }
  }
  function setMetricNumber(id, value, scale=12){
    const el = document.getElementById(id);
    const bar = document.getElementById(id+'Bar');
    const v = (value === Infinity) ? Infinity : Number(value || 0);
    el.classList.remove('green','red');
    el.classList.add((v === Infinity || v >= 1) ? 'green' : 'red'); // PF>=1 hijau
    el.innerText = (v === Infinity) ? '∞' : v.toFixed(2);
    if(bar){
      const pct = (v === Infinity) ? 100 : clamp(v*scale, 0, 100);
      bar.style.width = pct + '%';
      bar.style.background = (v === Infinity || v >= 1) ? '#22c55e' : '#ef4444';
    }
  }

  // Core update
  function update(){
    // Ambil modal awal dari input
    const start = parseFloat(document.getElementById('capital').value) || 0;
    let cap = start;
    const eq = [];

    let profit=0, loss=0, winDays=0, activeDays=0;
    let peak=cap, maxDD=0;
    let winSum=0, lossSum=0, winCount=0, lossCount=0;

    data.forEach(p=>{
      if(p!=null){
        activeDays++;
        cap += p;
        eq.push(cap);
        if(p>0){ profit += p; winDays++; winSum += p; winCount++; }
        else if(p<0){ loss += Math.abs(p); lossSum += Math.abs(p); lossCount++; }
        peak = Math.max(peak, cap);
        const ddNow = safeDiv((cap - peak), (peak || 1)); // negative or zero
        maxDD = Math.min(maxDD, ddNow);
      }
    });

    const net = cap - start;
    const winRate = activeDays ? (winDays/activeDays)*100 : 0;
    const pf = loss > 0 ? (profit / loss) : (profit > 0 ? Infinity : 0);
    const avgWin = winCount ? (winSum/winCount) : 0;
    const avgLoss = lossCount ? (lossSum/lossCount) : 0;
    const awlRatio = avgLoss ? (avgWin/avgLoss) : 0;
    const ddPct = maxDD * 100; // negative or zero
    const monthlyRet = start ? (((cap/start)-1)*100) : 0;

    setMetricCurrency('net', net, 100);
    setMetricCurrency('equity', cap, 100);
    setMetricPercent('winrate', winRate);
    setMetricPercent('daywin', winRate);
    setMetricNumber('pf', pf, 12);
    setMetricNumber('awl', awlRatio, 33);

    renderWeeks();
    setMetricPercent('dd', ddPct);
    setMetricPercent('rm', monthlyRet);
    setMetricPercent('rq', monthlyRet);
    renderDays();
    drawChart(eq, start);

    saveToStorage();
  }

  function renderWeeks(){
    const w=[0,0,0,0];
    data.forEach((p,i)=>{ if(p!=null){ const idx=Math.floor(i/7); if(idx<4) w[idx]+=p; }});
    setMetricCurrency('w1', w[0], 100);
    setMetricCurrency('w2', w[1], 100);
    setMetricCurrency('w3', w[2], 100);
    setMetricCurrency('w4', w[3], 100);
  }

  // Modifikasi: tampilkan bulan + tahun di label hari
  function renderDays(){
    const c=document.getElementById('days'); 
    c.innerHTML='';
    const m=document.getElementById('month').value || '';
    const y=document.getElementById('year').value || '';

    for(let i=0;i<31;i++){
      const p=data[i];
      const div=document.createElement('div'); 
      div.className='day';
      const label = `Day ${i+1} - ${m} ${y}`;
      if(p!=null){
        div.classList.add(p>=0?'win':'loss');
        div.innerHTML=`${label}<br>${fmtUSD(p)}<br>
          <button onclick="edit(${i})">Edit</button>
          <button onclick="removeDay(${i})">Remove</button>`;
      }else{
        div.innerHTML=`${label}<br>—`;
      }
      c.appendChild(div);
    }
  }

  function edit(i){
    const cur=data[i]??0;
    const p=parseFloat(prompt('Edit P&L Day '+(i+1), cur));
    if(!isNaN(p)){ data[i]=p; update(); }
  }
  function removeDay(i){ data[i]=null; update(); }

  function drawChart(eq, start){
    const ctx=document.getElementById('equityChart').getContext('2d');
    if(chart) chart.destroy();
    const labels = (eq.length ? eq : [start]).map((_,i)=> (eq.length ? ('Day '+(i+1)) : 'Start'));
    const points = eq.length ? eq : [start];
    chart=new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[{
          label:'Equity ($)',
          data:points,
          borderColor:'#22c55e',
          backgroundColor:'rgba(34,197,94,0.12)',
          borderWidth:2,
          fill:true,
          tension:0.3,
          pointRadius:0
        }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:false}, tooltip:{ mode:'index', intersect:false } },
        scales:{ x:{ grid:{ display:false } }, y:{ grid:{ color:'#1f2933' }, ticks:{ color:'#cbd5e1' } } }
      }
    });
  }

  function exportPDF(){
    const el=document.getElementById('journal');
    const m=document.getElementById('month').value || 'Bulan';
    const y=document.getElementById('year').value || 'Tahun';
    const opt={
      margin:0.5,
      filename:`Trading_Journal_${m}_${y}.pdf`,
      image:{ type:'jpeg', quality:0.98 },
      html2canvas:{ scale:2 },
      jsPDF:{ unit:'in', format:'a4', orientation:'portrait' }
    };
    html2pdf().set(opt).from(el).save();
  }

  // Reset Modal Awal (default 1000)
  function resetCapital(){
    if(confirm('Reset Modal Awal ke default?')){
      const capitalInput = document.getElementById('capital');
      capitalInput.value = 1000;
      localStorage.setItem('modalAwal', capitalInput.value);
      update();
    }
  }

  // Init
  window.addEventListener('DOMContentLoaded', ()=>{
    // Pasang judul dulu
    updateHeader();

    // Ambil modalAwal dari localStorage (key terpisah)
    const capitalInput = document.getElementById('capital');
    const savedCapital = localStorage.getItem('modalAwal');
    if (savedCapital !== null) {
      capitalInput.value = savedCapital;
    } else {
      localStorage.setItem('modalAwal', capitalInput.value);
    }

    // Load data harian sesuai bulan/tahun
    loadFromStorage();

    // Render pertama
    update();

    // Listeners
    document.getElementById('month').addEventListener('change', reloadData);
    document.getElementById('year').addEventListener('change', reloadData);

    // Saat modalAwal diubah, simpan dan update metrik
    capitalInput.addEventListener('change', function () {
      localStorage.setItem('modalAwal', this.value);
      update();
    });

    // Tombol-tombol
    document.getElementById('saveDayBtn').addEventListener('click', saveDay);
    document.getElementById('clearDayBtn').addEventListener('click', clearDay);
    document.getElementById('resetMonthBtn').addEventListener('click', resetMonth);
    document.getElementById('resetCapitalBtn').addEventListener('click', resetCapital);
  });
</script>
</body>
</html>

